---
title: "Stockr - Interactive Stock Viewer"
subtitle: "Track your portfolio in real-time"
format: html
engine: knitr
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(plotly)
library(dplyr)
library(duckdb)
library(crosstalk)
library(htmltools)
library(xts)
library(TTR)
library(zoo)
```

## Welcome to Stockr

Interactive stock price tracking with real-time charts and filtering.

```{r load-data}
# Load stock data
con <- dbConnect(duckdb(), dbdir = "data/stocks.duckdb", read_only = TRUE)
stock_data <- dbGetQuery(con, "SELECT * FROM stock_prices ORDER BY date DESC")
dbDisconnect(con)

# Convert date to proper format and sort
stock_data$date <- as.Date(stock_data$date)
stock_data <- stock_data %>% arrange(ticker, date)

# Get unique tickers and date range
tickers <- unique(stock_data$ticker)
date_min <- min(stock_data$date)
date_max <- max(stock_data$date)

# Shared data for client-side filtering
sd <- SharedData$new(stock_data, key = ~ticker, group = "ticker")
```

## üéõÔ∏è Ticker Selection

Use the dropdown to pick one of the preselected tickers (SLV, NVDA, AAPL, ADBE, MP). You can also type another ticker symbol; if it's present in the dataset it will display. To add a brand-new ticker, run the fetch script with that symbol and re-render.

```{r ticker-filter}
filter_select(
  id = "ticker",
  label = "Select ticker (type to search or add):",
  sharedData = sd,
  ~ticker,
  multiple = FALSE
)
```

```{=html}
<div style="margin-top: 0.5rem; margin-bottom: 1rem;">
  <label for="ticker-input" style="font-weight: 600;">Add or jump to a ticker (type symbol and click Apply):</label><br>
  <input id="ticker-input" type="text" placeholder="e.g. TSLA" style="padding:6px; width:180px; margin-right:6px;">
  <button id="ticker-apply" style="padding:6px 10px;">Apply</button>
  <small style="margin-left:6px; color:#555;">(If the ticker isn't in the dataset, add it in R/fetch_data.R then rerun render_site.)</small>
</div>
<script>
  (() => {
    const handle = new crosstalk.FilterHandle('ticker');
    const input = document.getElementById('ticker-input');
    const btn = document.getElementById('ticker-apply');
    if (btn && input) {
      btn.addEventListener('click', () => {
        const val = (input.value || '').trim().toUpperCase();
        if (val) handle.set({'ticker': [val]});
      });
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const val = (input.value || '').trim().toUpperCase();
          if (val) handle.set({'ticker': [val]});
        }
      });
    }
  })();
</script>
```

## üìä Stock Price Chart

```{r price-chart}
# Create interactive price chart
p1 <- plot_ly(sd, x = ~date, y = ~close, type = 'scatter', mode = 'lines',
          name = ~ticker, color = ~ticker) %>%
  layout(
    title = "Stock Price History",
    xaxis = list(title = "Date"),
    yaxis = list(title = "Price ($)"),
    hovermode = "x unified",
    template = "plotly_white",
    height = 500
  )

p1
```

## üïØÔ∏è Candlestick Chart

```{r candlestick-chart}
# Create candlestick chart
p_candle <- sd %>%
  plot_ly(x = ~date, type = "candlestick",
          open = ~open, close = ~close,
          high = ~high, low = ~low,
          name = ~ticker) %>%
  layout(
    title = "OHLC Candlestick Chart",
    xaxis = list(
      title = "Date",
      rangeslider = list(visible = FALSE)
    ),
    yaxis = list(title = "Price ($)"),
    template = "plotly_white",
    height = 500
  )

p_candle
```

## üìà Trading Volume

```{r volume-chart}
# Create volume chart
p2 <- plot_ly(sd, x = ~date, y = ~volume, type = 'bar',
          name = ~ticker, color = ~ticker) %>%
  layout(
    title = "Trading Volume",
    xaxis = list(title = "Date"),
    yaxis = list(title = "Volume"),
    hovermode = "x unified",
    template = "plotly_white",
    height = 400
  )

p2
```

## üìã Data Summary

```{r data-table}
library(knitr)

# Show summary statistics
summary_stats <- stock_data %>%
  group_by(ticker) %>%
  summarise(
    Records = n(),
    First_Date = format(min(date), "%Y-%m-%d"),
    Last_Date = format(max(date), "%Y-%m-%d"),
    Min_Price = paste0("$", round(min(close), 2)),
    Max_Price = paste0("$", round(max(close), 2)),
    Avg_Price = paste0("$", round(mean(close), 2)),
    Current_Price = paste0("$", round(last(close), 2)),
    .groups = 'drop'
  )

kable(summary_stats, format = "html")
```

## üìÖ Latest Prices (Last 30 Trading Days)

```{r recent-prices}
recent <- stock_data %>%
  arrange(desc(date)) %>%
  slice_head(n = 30) %>%
  arrange(date) %>%
  select(Date = date, Ticker = ticker, Open = open, High = high, 
         Low = low, Close = close, Volume = volume) %>%
  mutate(
    Open = paste0("$", round(Open, 2)),
    High = paste0("$", round(High, 2)),
    Low = paste0("$", round(Low, 2)),
    Close = paste0("$", round(Close, 2)),
    Volume = format(Volume, big.mark = ",")
  )

kable(recent, format = "html")
```

## üìä Price Range Distribution

```{r price-distribution}
# Create histogram of closing prices
p3 <- plot_ly(sd, x = ~close, type = 'histogram', nbinsx = 50,
          name = 'Price Distribution',
          marker = list(color = 'rgba(52, 152, 219, 0.7)')) %>%
  layout(
    title = "Closing Price Distribution",
    xaxis = list(title = "Price ($)"),
    yaxis = list(title = "Frequency"),
    template = "plotly_white",
    height = 400
  )

p3
```

## üìë SMA 200 Table

::: {.panel-tabset}
### SMA Metrics

```{r sma-table}
library(knitr)

sma_metrics <- stock_data %>%
  arrange(ticker, date) %>%
  group_by(ticker) %>%
  group_modify(~ {
    x <- .x
    hlc_xts <- xts::xts(x[, c("high", "low", "close")], order.by = x$date)
    atr30 <- as.numeric(TTR::ATR(hlc_xts, n = 30)[, "atr"])
    close <- x$close
    sma200 <- zoo::rollapply(close, 200, mean, align = "right", fill = NA, na.rm = TRUE)
    ma50 <- zoo::rollapply(close, 50, mean, align = "right", fill = NA, na.rm = TRUE)
    pct_from_sma200 <- (close / sma200 - 1) * 100
    pct_from_ma50 <- ((close - ma50) / ma50) * 100
    atr_pct <- (atr30 / close) * 100
    extension_ratio <- pct_from_ma50 / atr_pct
    tibble(
      ticker = x$ticker,
      date = x$date,
      close = close,
      sma200 = sma200,
      ma50 = ma50,
      atr30 = atr30,
      pct_from_sma200 = pct_from_sma200,
      pct_from_ma50 = pct_from_ma50,
      atr_pct = atr_pct,
      extension_ratio = extension_ratio
    )
  }) %>%
  ungroup()

sma_table <- sma_metrics %>%
  filter(
    !is.na(sma200),
    !is.na(ma50),
    !is.na(atr30),
    !is.na(atr_pct),
    atr_pct != 0
  ) %>%
  group_by(ticker) %>%
  slice_tail(n = 1) %>%
  mutate(
    Close = paste0("$", round(close, 2)),
    SMA200 = paste0("$", round(sma200, 2)),
    Pct_from_SMA200 = paste0(round(pct_from_sma200, 2), "%"),
    MA50 = paste0("$", round(ma50, 2)),
    Pct_from_MA50 = paste0(round(pct_from_ma50, 2), "%"),
    ATR30 = paste0("$", round(atr30, 2)),
    ATR_pct = paste0(round(atr_pct, 2), "%"),
    Extension_Ratio = round(extension_ratio, 2)
  ) %>%
  select(
    Ticker = ticker,
    Date = date,
    Close,
    SMA200,
    Pct_from_SMA200,
    MA50,
    Pct_from_MA50,
    ATR30,
    ATR_pct,
    Extension_Ratio
  ) %>%
  arrange(Ticker)

kable(sma_table, format = "html", caption = "SMA & ATR Extension (latest close)")
```

### Notes

- SMA200 is the 200-day simple moving average per ticker.
- Pct_from_SMA200 = (Close / SMA200 - 1) * 100.
- Extension_Ratio = Pct_from_MA50 divided by ATR_pct (ATR30 as % of price); higher values mean price is stretched versus typical volatility.
- To analyze a new ticker, add it to `R/fetch_data.R`, run `Rscript R/render_site.R`, then refresh.

:::

---

**Data Source:** Yahoo Finance  
**Last Updated:** `r format(max(stock_data$date), '%Y-%m-%d')`  
**Records:** `r nrow(stock_data)` pricing records
